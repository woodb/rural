#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
rural
~~~~~
Simple command line utility for uploading local files to Amazon Web Services
(AWS) Simple Storage Service (S3).
"""

CONFIG_MISSING_MESSAGE = """rural has not yet been configured, or the configuration 
file appears to be missing. Run the configuration wizard with `rural --configure`
"""

from xerox import copy
from boto.s3.connection import S3Connection
from boto.s3.key import Key
from boto.s3.bucket import Bucket

class RuralSession(object):
    aws_access_key_id = None
    aws_secret_access_key = None
    connection = None
    bucket = None
    bucket_name = None
    url = None

    def __init__(self, aws_access_key_id, aws_secret_access_key, bucket_name):
        self.aws_access_key_id = aws_access_key_id
        self.aws_secret_access_key = aws_secret_access_key
        self.bucket_name = bucket_name
        self._connect()

    def _check_config(self):
        if self.aws_access_key_id and self.aws_secret_access_key and self.bucket_name:
            self._connect()
        else:
            raise EnvironmentError("Rural object configuration incomplete")

    def _connect(self):
        if self.connection is None:
            self.connection = S3Connection(
                aws_access_key_id=self.aws_access_key_id,
                aws_secret_access_key=self.aws_secret_access_key
            )

        if self.bucket is None:
            self.bucket = Bucket(self.connection, self.bucket_name)

    def upload(self, filename, cb=None):
        """
        Upload a local file to a pre-specified S3 bucket.

        :type fh: file handle
        :param fh: file handle to upload to S3
        """
        self._check_config()

        self.key = Key(self.bucket)
        self.key.key = filename
        self.key.set_contents_from_filename(filename, cb=cb)

    def publicize(self):
        self.key.make_public()
        self.url = self.key.generate_url(86400)
        self.url = ''.join(self.url.split('?')[:-1])



def _create_config(fh):
    """
    rural._create_config
    ~~~~~~~~~~~~~~~~~~~~
    Prompts to create the configuration file.
    """
    sys.stdout.write("AWS Access Key ID: ")
    aws_access_key = raw_input().upper()

    sys.stdout.write("   AWS Secret Key: ")
    aws_secret_key = raw_input()

    sys.stdout.write("   Default Bucket: ")
    default_bucket_name = raw_input()

    fh.write(yaml.dump({'aws_access_key' : aws_access_key,
               'aws_secret_key' : aws_secret_key,
               'bucket_name'    : default_bucket_name},
               Dumper=Dumper))


def _load_config(fh):
    cfg_data = yaml.load(fh)
    return cfg_data['aws_access_key'], cfg_data['aws_secret_key'], \
        cfg_data['bucket_name']


def _cb_progressbar(uploaded_bytes, total_bytes):
    """Callback function that outputs a progressbar to stderr based on what's
    up"""
    import sys

    pbw = 80 # progress bar width 

    progress_percent = float(uploaded_bytes) / float(total_bytes)

    sys.stderr.write("\r[%s%s] %d%%" % (
        '=' * int(progress_percent * pbw / 2),
        ' ' * (pbw / 2- int(progress_percent * pbw / 2)),
        int(progress_percent * 100)))

    if progress_percent == 1:
        sys.stderr.write("\n")


def _main():
    """
    rural._main
    ~~~~~~~~~~~
    Handles option parsing, configuration management and command execution.
    """
    # Parse command line arguments
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("filename", help="name of file to upload", nargs='?',
            default=None)
    parser.add_argument("--configure", dest="configure", action="store_true")
    args = parser.parse_args()
    if args.filename:
        filename = args.filename
    else:
        raise IOError("filename must be defined at runtime")

    
    # Configuration
    # ~~~~~~~~~~~~~
    config_file = None
    if os.getenv("HOME"):
        config_file = os.path.join(os.getenv("HOME"), ".rural")
    else:
        raise NotImplementedError, "rural currently only supports POSIX \
            compliant environments (i.e. rural does not work on Windows)"
        sys.exit(1)

    try:
        config_fh = open(config_file, "r")
    except IOError:
        if not args.configure:
            print CONFIG_MISSING_MESSAGE
            sys.exit(1)

    if args.configure:
        config_fh = open(config_file, 'w')
        _create_config(config_fh)
        sys.exit(0)

    aws_access_key_id, aws_secret_access_key, bucket_name = _load_config(config_fh)
    rural_session = RuralSession(aws_access_key_id=aws_access_key_id,
            aws_secret_access_key=aws_secret_access_key,
            bucket_name=bucket_name)
    rural_session.upload(filename, cb=_cb_progressbar)
    rural_session.publicize()
    copy(rural_session.url)
    print rural_session.url


if __name__ == '__main__':
    import os
    import sys

    import yaml
    try:
        from yaml import CLoader as Loader, CDumper as Dumper
    except ImportError:
        from yaml import Loader, Dumper
    except Exception as exc:
        raise exc
        sys.exit(1)

    _main()
