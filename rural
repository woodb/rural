#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
rural
~~~~~
Simple command line utility for uploading local files to Amazon Web Services
(AWS) Simple Storage Service (S3).
"""
import sys
import logging

import click
from xerox import copy
from boto.s3.connection import S3Connection
from boto.s3.key import Key
from boto.s3.bucket import Bucket

class RuralSession(object):
    aws_access_key_id = None
    aws_secret_access_key = None
    connection = None
    bucket = None
    bucket_name = None
    url = None

    def __init__(self, aws_access_key_id, aws_secret_access_key, bucket_name):
        self.aws_access_key_id = aws_access_key_id
        self.aws_secret_access_key = aws_secret_access_key
        self.bucket_name = bucket_name
        self._check_config()

    def _check_config(self):
        if self.aws_access_key_id and self.aws_secret_access_key and self.bucket_name:
            self._connect()
        else:
            raise EnvironmentError("RuralSession object configuration incomplete")

    def _connect(self):
        self.connection = S3Connection(
            aws_access_key_id=self.aws_access_key_id,
            aws_secret_access_key=self.aws_secret_access_key
        )
        self.bucket = Bucket(self.connection, self.bucket_name)

    def upload(self, filename, cb=None):
        """
        Upload a local file to a pre-specified S3 bucket.

        :type fh: file handle
        :param fh: file handle to upload to S3
        """
        self._check_config()
        self.key = Key(self.bucket)
        self.key.key = filename
        self.key.set_contents_from_filename(filename, cb=cb)

    def publicize(self):
        self.key.make_public()
        self.url = self.key.generate_url(86400)
        self.url = ''.join(self.url.split('?')[:-1])


def _cb_progressbar(uploaded_bytes, total_bytes):
    """Callback function that outputs a progressbar to stderr based on what's
    up"""
    pbw = 80 # progress bar width 
    progress_percent = float(uploaded_bytes) / float(total_bytes)
    sys.stderr.write("\r[%s%s] %d%%" % (
        '=' * int(progress_percent * pbw / 2),
        ' ' * (pbw / 2 - int(progress_percent * pbw / 2)),
        int(progress_percent * 100)))
    if progress_percent == 1:
        sys.stderr.write("\n")

def initialize(verbosity=0):
    """Setup loggers, basically """
    global log
    log = logging.Logger("rural")
    log.verbosity = verbosity
    log.stream = sys.stderr
    log_handler = logging.StreamHandler(log.stream)
    log.addHandler(log_handler)
    if verbosity == 3:
        log.setLevel(logging.DEBUG)
    elif verbosity == 2:
        log.setLevel(logging.INFO)
    else:
        log.setLevel(logging.ERROR)

@click.command()
@click.option('--aws-access-key-id', envvar='AWS_ACCESS_KEY_ID',
        help='AWS Access Key ID for the AWS API')
@click.option('--aws-secret-access-key', envvar='AWS_SECRET_ACCESS_KEY',
        help='AWS Secret Access Key for the AWS API')
@click.option('--bucket-name', '-b', envvar='RURAL_BUCKET_NAME',
        help='bucket name to which to upload/link files', required=True)
@click.option('--verbose', '-v', count=True)
@click.option('--silent/--loud', '-s', help='disable printing of URL', default=False)
@click.argument('filename', required=True)
def upload_copy(aws_access_key_id, aws_secret_access_key, bucket_name, 
        verbose, silent, filename):
    """
    Uploads a local file to AWS S3 and copy a publicly accessible link to the
    file to the clipboard.

    Environment variables can be set to configure this script, namely:

        AWS_ACCESS_KEY_ID
        AWS_SECRET_ACCESS_KEY_ID
        RURAL_BUCKET_NAME

    """
    initialize(verbose)

    cb = None
    if verbose > 0:
        cb = _cb_progressbar
        log.debug("AWS Access Key ID:\t{}".format(aws_access_key_id))
        log.debug("AWS Secret Access Key:\t{}".format(aws_secret_access_key))
        log.debug("Bucket:\t{}".format(bucket_name))
    rural_session = RuralSession(
            aws_access_key_id=aws_access_key_id,
            aws_secret_access_key=aws_secret_access_key,
            bucket_name=bucket_name)
    rural_session.upload(filename, cb=cb)
    rural_session.publicize()
    copy(rural_session.url)
    if not silent:
        print rural_session.url

if __name__ == '__main__':
    upload_copy()
